apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: shazamqclusters.shazamq.io
  annotations:
    controller-gen.kubebuilder.io/version: v0.13.0
spec:
  group: shazamq.io
  names:
    kind: ShazamqCluster
    listKind: ShazamqClusterList
    plural: shazamqclusters
    singular: shazamqcluster
    shortNames:
      - sqc
      - shazamq
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          description: ShazamqCluster is the Schema for the shazamqclusters API
          type: object
          properties:
            apiVersion:
              description: 'APIVersion defines the versioned schema of this representation'
              type: string
            kind:
              description: 'Kind is a string value representing the REST resource'
              type: string
            metadata:
              type: object
            spec:
              description: ShazamqClusterSpec defines the desired state of ShazamqCluster
              type: object
              required:
                - replicas
              properties:
                # Cluster Configuration
                replicas:
                  description: Number of broker replicas (minimum 3 for HA)
                  type: integer
                  minimum: 1
                  default: 3
                
                version:
                  description: Shazamq version to deploy
                  type: string
                  default: "0.1.1-rc1"
                
                image:
                  description: Docker image for Shazamq
                  type: string
                  default: "shazamq/shazamq"
                
                imagePullPolicy:
                  description: Image pull policy
                  type: string
                  enum: ["Always", "IfNotPresent", "Never"]
                  default: "IfNotPresent"
                
                imagePullSecrets:
                  description: Image pull secrets
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                
                # Storage Configuration
                storage:
                  description: Storage configuration
                  type: object
                  properties:
                    volumeClaimTemplate:
                      description: Volume claim template for data storage
                      type: object
                      properties:
                        spec:
                          type: object
                          properties:
                            accessModes:
                              type: array
                              items:
                                type: string
                            resources:
                              type: object
                              properties:
                                requests:
                                  type: object
                                  properties:
                                    storage:
                                      type: string
                                      default: "100Gi"
                            storageClassName:
                              type: string
                    
                    segmentBytes:
                      description: Log segment size in bytes
                      type: integer
                      default: 1073741824
                    
                    retentionHours:
                      description: Data retention in hours
                      type: integer
                      default: 168
                    
                    retentionBytes:
                      description: Data retention in bytes
                      type: integer
                      default: 107374182400
                
                # Tiered Storage (S3/GCS)
                tieredStorage:
                  description: Tiered storage configuration
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: false
                    
                    provider:
                      type: string
                      enum: ["s3", "gcs", "azure"]
                      default: "s3"
                    
                    hotTierRetentionHours:
                      type: integer
                      default: 24
                    
                    s3:
                      type: object
                      properties:
                        bucket:
                          type: string
                        region:
                          type: string
                        endpoint:
                          type: string
                        prefix:
                          type: string
                        credentialsSecret:
                          type: string
                
                # Kafka Mirror Configuration
                mirror:
                  description: MirrorMaker configuration for Kafka-to-Shazamq replication
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: false
                    
                    sources:
                      description: List of Kafka clusters to mirror from
                      type: array
                      items:
                        type: object
                        required:
                          - name
                          - bootstrapServers
                        properties:
                          name:
                            description: Name of the source Kafka cluster
                            type: string
                          
                          bootstrapServers:
                            description: Kafka bootstrap servers (comma-separated)
                            type: string
                          
                          securityProtocol:
                            description: Security protocol (PLAINTEXT, SSL, SASL_PLAINTEXT, SASL_SSL)
                            type: string
                            default: "PLAINTEXT"
                          
                          saslMechanism:
                            description: SASL mechanism (PLAIN, SCRAM-SHA-256, SCRAM-SHA-512)
                            type: string
                          
                          credentialsSecret:
                            description: Secret containing SASL credentials
                            type: string
                          
                          topicWhitelist:
                            description: Topics to mirror (regex patterns)
                            type: array
                            items:
                              type: string
                            default: [".*"]
                          
                          topicBlacklist:
                            description: Topics to exclude (regex patterns)
                            type: array
                            items:
                              type: string
                          
                          consumerGroupId:
                            description: Consumer group ID for mirroring
                            type: string
                            default: "shazamq-mirror"
                          
                          numConsumers:
                            description: Number of consumer threads
                            type: integer
                            default: 4
                          
                          exactlyOnce:
                            description: Enable exactly-once semantics
                            type: boolean
                            default: true
                
                # Replication Configuration
                replication:
                  description: Replication settings
                  type: object
                  properties:
                    defaultReplicationFactor:
                      type: integer
                      default: 3
                    minInsyncReplicas:
                      type: integer
                      default: 2
                
                # Resource Configuration
                resources:
                  description: Resource requests and limits
                  type: object
                  properties:
                    requests:
                      type: object
                      properties:
                        cpu:
                          type: string
                          default: "1000m"
                        memory:
                          type: string
                          default: "2Gi"
                    limits:
                      type: object
                      properties:
                        cpu:
                          type: string
                          default: "4000m"
                        memory:
                          type: string
                          default: "8Gi"
                
                # Pod Configuration
                podAnnotations:
                  description: Annotations to add to broker pods
                  type: object
                  additionalProperties:
                    type: string
                
                podLabels:
                  description: Labels to add to broker pods
                  type: object
                  additionalProperties:
                    type: string
                
                nodeSelector:
                  description: Node selector for broker pods
                  type: object
                  additionalProperties:
                    type: string
                
                tolerations:
                  description: Tolerations for broker pods
                  type: array
                  items:
                    type: object
                    properties:
                      key:
                        type: string
                      operator:
                        type: string
                      value:
                        type: string
                      effect:
                        type: string
                      tolerationSeconds:
                        type: integer
                
                affinity:
                  description: Affinity rules for broker pods
                  type: object
                  x-kubernetes-preserve-unknown-fields: true
                
                # Service Configuration
                service:
                  description: Service configuration
                  type: object
                  properties:
                    type:
                      type: string
                      enum: ["ClusterIP", "NodePort", "LoadBalancer"]
                      default: "ClusterIP"
                    
                    port:
                      type: integer
                      default: 9092
                    
                    metricsPort:
                      type: integer
                      default: 9090
                    
                    annotations:
                      type: object
                      additionalProperties:
                        type: string
                
                # Security Configuration
                security:
                  description: Security configuration
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: false
                    
                    tls:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          default: false
                        secretName:
                          type: string
                    
                    auth:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          default: false
                        mechanism:
                          type: string
                          enum: ["PLAIN", "SCRAM-SHA-256", "SCRAM-SHA-512"]
                        secretName:
                          type: string
                
                # Monitoring Configuration
                monitoring:
                  description: Monitoring configuration
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: true
                    
                    serviceMonitor:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          default: true
                        interval:
                          type: string
                          default: "30s"
                        scrapeTimeout:
                          type: string
                          default: "10s"
                
                # Additional Configuration
                config:
                  description: Additional Shazamq configuration (TOML format)
                  type: object
                  x-kubernetes-preserve-unknown-fields: true
            
            status:
              description: ShazamqClusterStatus defines the observed state
              type: object
              properties:
                phase:
                  type: string
                  enum: ["Pending", "Creating", "Running", "Updating", "Failed"]
                
                replicas:
                  type: integer
                
                readyReplicas:
                  type: integer
                
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
                
                brokers:
                  type: array
                  items:
                    type: object
                    properties:
                      id:
                        type: integer
                      pod:
                        type: string
                      ready:
                        type: boolean
                      leader:
                        type: boolean
      
      subresources:
        status: {}
      
      additionalPrinterColumns:
        - name: Version
          type: string
          jsonPath: .spec.version
        - name: Replicas
          type: integer
          jsonPath: .spec.replicas
        - name: Ready
          type: integer
          jsonPath: .status.readyReplicas
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp

